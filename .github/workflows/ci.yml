name: ğŸ§ª Continuous Integration

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - '*.md'
      - 'docs/**'

env:
  RUST_REPO: 'lihongjie0209/fast-image'

jobs:
  test:
    name: ğŸ§ª Test on ${{ matrix.os }} with Java ${{ matrix.java }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [8, 11, 17, 21]
        
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          
      - name: ğŸ“¥ Download Latest Native Libraries
        shell: bash
        run: |
          # è·å–æœ€æ–°ç‰ˆæœ¬
          VERSION=$(curl -s https://api.github.com/repos/${{ env.RUST_REPO }}/releases/latest | jq -r .tag_name)
          echo "Using Rust version: $VERSION"
          
          # åˆ›å»ºç›®å½•
          mkdir -p src/main/resources/native
          
          # ä¸‹è½½æ‰€æœ‰å¹³å°çš„åŸç”Ÿåº“
          PLATFORMS=(
            "fast_image-windows-x86_64.dll"
            "fast_image-windows-aarch64.dll" 
            "libfast_image-linux-x86_64.so"
            "libfast_image-linux-aarch64.so"
            "libfast_image-macos-x86_64.dylib"
            "libfast_image-macos-aarch64.dylib"
          )
          
          for platform in "${PLATFORMS[@]}"; do
            echo "Downloading $platform..."
            curl -L -f \
              -H "Accept: application/octet-stream" \
              -o "src/main/resources/native/$platform" \
              "https://github.com/${{ env.RUST_REPO }}/releases/download/$VERSION/$platform" \
              || echo "Warning: Failed to download $platform"
          done
          
          echo "Downloaded files:"
          find src/main/resources/native/ -type f -exec ls -la {} \;
          
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: ğŸ”§ Compile Project
        run: mvn clean compile test-compile
        
      - name: ğŸ§ª Run Unit Tests
        run: mvn test
        
      - name: ğŸ“Š Run Quick Benchmark (Java 8 only)
        if: matrix.java == 8
        run: mvn exec:java@benchmark
        continue-on-error: true  # åŸºå‡†æµ‹è¯•å¤±è´¥ä¸å½±å“CIçŠ¶æ€
        
      - name: ğŸ“¦ Package JAR
        run: mvn package -DskipTests
        
      - name: ğŸ” Verify JAR Contents
        shell: bash
        run: |
          echo "=== JAR Contents ==="
          jar -tf target/*.jar | head -20
          
          echo "=== Native Libraries in JAR ==="
          jar -tf target/*.jar | grep -E '\.(dll|so|dylib)$' || echo "No native libraries found"
          
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarCloudéœ€è¦å®Œæ•´å†å²
          
      - name: â˜• Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: 11
          distribution: 'temurin'
          
      - name: ğŸ“¥ Download Latest Native Libraries
        run: |
          VERSION=$(curl -s https://api.github.com/repos/${{ env.RUST_REPO }}/releases/latest | jq -r .tag_name)
          mkdir -p src/main/resources/native
          
          PLATFORMS=("fast_image-windows-x86_64.dll" "libfast_image-linux-x86_64.so" "libfast_image-macos-x86_64.dylib")
          for platform in "${PLATFORMS[@]}"; do
            curl -L -f \
              -H "Accept: application/octet-stream" \
              -o "src/main/resources/native/$platform" \
              "https://github.com/${{ env.RUST_REPO }}/releases/download/$VERSION/$platform" || true
          done
          
      - name: ğŸ“¦ Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
          
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: ğŸ” Run SonarCloud Analysis
        if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.projectKey=lihongjie0209_fast-image-java \
            -Dsonar.organization=lihongjie0209 \
            -Dsonar.host.url=https://sonarcloud.io
