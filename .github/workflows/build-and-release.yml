name: ğŸš€ Build and Release Fast Image Java

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      rust_version:
        description: 'Rust release version to use (e.g., v0.2.1)'
        required: false
        default: 'latest'
      create_release:
        description: 'Create GitHub Release'
        type: boolean
        default: true
        required: false

env:
  JAVA_VERSION: '8'
  MAVEN_VERSION: '3.8.6'
  RUST_REPO: 'lihongjie0209/fast-image'

jobs:
  # ä¸‹è½½RuståŸç”Ÿåº“
  download-native-libs:
    name: ğŸ“¥ Download Native Libraries
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è®¾ç½®10åˆ†é’Ÿè¶…æ—¶
    
    outputs:
      rust-version: ${{ steps.get-version.outputs.version }}
      
    steps:
      - name: ğŸ” Get Latest Rust Release
        id: get-version
        run: |
          if [ "${{ github.event.inputs.rust_version }}" = "latest" ] || [ -z "${{ github.event.inputs.rust_version }}" ]; then
            VERSION=$(curl -s https://api.github.com/repos/${{ env.RUST_REPO }}/releases/latest | jq -r .tag_name)
          else
            VERSION="${{ github.event.inputs.rust_version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using Rust version: $VERSION"
          
      - name: ğŸ“¦ Download Native Libraries
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          echo "Downloading native libraries from version: $VERSION"
          
          # åˆ›å»ºç›®å½•
          mkdir -p native-libs
          
          # ä¸‹è½½æ‰€æœ‰å¹³å°çš„åŸç”Ÿåº“
          PLATFORMS=(
            "fast_image-windows-x86_64.dll"
            "fast_image-windows-aarch64.dll"
            "libfast_image-linux-x86_64.so"
            "libfast_image-linux-aarch64.so"
            "libfast_image-macos-x86_64.dylib"
            "libfast_image-macos-aarch64.dylib"
          )
          
          for platform in "${PLATFORMS[@]}"; do
            echo "Downloading $platform..."
            curl -L -f \
              -H "Accept: application/octet-stream" \
              -o "native-libs/$platform" \
              "https://github.com/${{ env.RUST_REPO }}/releases/download/$VERSION/$platform" \
              || echo "Warning: Failed to download $platform (may not exist in this release)"
          done
          
          # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶
          echo "Downloaded files:"
          ls -la native-libs/
          
      - name: ğŸ—œï¸ Create Native Libraries Archive
        run: |
          cd native-libs
          tar -czf ../native-libraries.tar.gz *
          cd ..
          
      - name: ğŸ“¤ Upload Native Libraries
        uses: actions/upload-artifact@v4
        with:
          name: native-libraries
          path: native-libraries.tar.gz
          retention-days: 1

  # æ„å»ºå’Œæµ‹è¯• - åªæ„å»ºä¸€æ¬¡ç”¨äºå‘å¸ƒ
  build-and-test:
    name: ğŸ”¨ Build and Package
    needs: download-native-libs
    runs-on: ubuntu-latest
    timeout-minutes: 15  # è®¾ç½®15åˆ†é’Ÿè¶…æ—¶
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          
      - name: ğŸ“¥ Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          name: native-libraries
          
      - name: ğŸ“‚ Extract Native Libraries
        shell: bash
        run: |
          # åˆ›å»ºèµ„æºç›®å½•
          mkdir -p src/main/resources/native
          
          # è§£å‹åŸç”Ÿåº“åˆ°æ­£ç¡®ä½ç½®
          tar -xzf native-libraries.tar.gz -C src/main/resources/native/
          
          # æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
          echo "Native libraries structure:"
          find src/main/resources/native/ -type f -exec ls -la {} \;
          
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: ğŸ”§ Compile and Test
        run: mvn clean compile test -q
        
      - name: ğŸ“Š Run Performance Benchmark
        run: mvn exec:java@benchmark -q
        continue-on-error: true  # åŸºå‡†æµ‹è¯•å¤±è´¥ä¸å½±å“æ„å»º
        
      - name: ğŸ“¦ Package Universal JAR
        run: mvn package -DskipTests -q
        
      - name: ï¿½ Verify JAR Contents
        run: |
          echo "=== JAR Contents ==="
          jar -tf target/*.jar | head -20
          echo "=== Native Libraries in JAR ==="
          jar -tf target/*.jar | grep -E '\.(dll|so|dylib)$'
        
      - name: ğŸ“¤ Upload JAR Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-image-java-universal
          path: target/*.jar
          retention-days: 30

  # å‘å¸ƒç‰ˆæœ¬
  create-release:
    name: ğŸ‰ Create Release
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/v')
    needs: [download-native-libs, build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 20  # è®¾ç½®20åˆ†é’Ÿè¶…æ—¶
    
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          
      - name: ğŸ“¥ Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          name: native-libraries
          
      - name: ï¿½ Download JAR Artifacts  
        uses: actions/download-artifact@v4
        with:
          name: fast-image-java-universal
          path: artifacts/
          
      - name: ï¿½ğŸ“‚ Extract Native Libraries
        run: |
          mkdir -p src/main/resources/native
          tar -xzf native-libraries.tar.gz -C src/main/resources/native/
          
      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          if [ "${{ startsWith(github.ref, 'refs/tags/v') }}" = "true" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION="v$(date +%Y%m%d)-$(echo $GITHUB_SHA | cut -c1-8)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rust_version=${{ needs.download-native-libs.outputs.rust-version }}" >> $GITHUB_OUTPUT
          
      - name: ğŸ“¦ Prepare Release Files
        run: |
          # åˆ›å»ºå‘å¸ƒæ–‡ä»¶
          mkdir -p release-assets
          
          # å¤åˆ¶JARæ–‡ä»¶å¹¶é‡å‘½å
          cp artifacts/*.jar release-assets/
          
          # é‡å‘½åä¸»è¦JARæ–‡ä»¶
          cd release-assets
          for jar in *.jar; do
            if [[ $jar == *"-javadoc.jar" ]]; then
              mv "$jar" "fast-image-java-${{ steps.version.outputs.version }}-javadoc.jar"
            elif [[ $jar == *"-sources.jar" ]]; then
              mv "$jar" "fast-image-java-${{ steps.version.outputs.version }}-sources.jar"  
            elif [[ $jar != *"-javadoc.jar" && $jar != *"-sources.jar" ]]; then
              mv "$jar" "fast-image-java-${{ steps.version.outputs.version }}.jar"
            fi
          done
          
          # åˆ›å»ºæºç åŒ…
          cd ..
          git archive --format=zip --output=release-assets/fast-image-java-${{ steps.version.outputs.version }}-sources.zip HEAD
          
      - name: ğŸ“‹ Generate Release Notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          # Fast Image Java ${{ steps.version.outputs.version }}
          
          ## ğŸ“¦ Java Library for High-Performance Image Compression
          
          This release contains the Java JNI wrapper for the Fast Image compression library.
          
          ### ğŸš€ Features
          - High-performance JPEG compression using Rust backend
          - Cross-platform native library support (Windows/Linux/macOS)  
          - Comprehensive performance benchmarking suite
          - Easy-to-use API with quality control
          
          ### ğŸ“Š Performance Highlights
          - **Compression Ratio**: 10-16% better than JDK ImageIO
          - **Memory Efficiency**: 33% less memory usage
          - **Cross-Platform**: Consistent results across all platforms
          
          ### ğŸ”— Dependencies
          - **Native Libraries**: Built from [fast-image ${{ steps.version.outputs.rust-version }}](https://github.com/${{ env.RUST_REPO }}/releases/tag/${{ steps.version.outputs.rust-version }})
          - **Java Version**: Java 8+
          - **Platforms**: Windows (x64/ARM64), Linux (x64/ARM64), macOS (Intel/Apple Silicon)
          
          ### ğŸ“¥ Download
          - `fast-image-java-${{ steps.version.outputs.version }}.jar` - Complete library with native dependencies
          - `fast-image-java-${{ steps.version.outputs.version }}-sources.zip` - Source code
          
          ### ğŸš€ Quick Start
          ```java
          import cn.lihongjie.image.FastImageUtils;
          
          // Load and compress an image
          byte[] imageData = Files.readAllBytes(Paths.get("image.jpg"));
          byte[] compressed = FastImageUtils.compress(imageData, 70);
          
          // Save compressed result
          Files.write(Paths.get("compressed.jpg"), compressed);
          ```
          
          ### ğŸ§ª Performance Testing
          ```bash
          # Clone and test
          git clone https://github.com/your-username/fast-image-java.git
          cd fast-image-java
          mvn exec:java@benchmark
          ```
          
          ### ğŸ“š Documentation
          - [Performance Comparison Report](JPEG-COMPRESSION-COMPARISON.md)
          - [Quick Decision Guide](DECISION-GUIDE.md)
          - [Usage Guide](QUICK-GUIDE.md)
          
          Built with â¤ï¸ using Rust + JNI
          EOF
          
          # è®¾ç½®è¾“å‡º
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Fast Image Java ${{ steps.version.outputs.version }}"
          body: ${{ steps.release-notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ°GitHub Packages
  publish-github-packages:
    name: ğŸ“¦ Publish to GitHub Packages
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/v')
    needs: [download-native-libs, build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          server-id: github
          server-username: GITHUB_ACTOR
          server-password: GITHUB_TOKEN
          
      - name: ğŸ“¥ Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          name: native-libraries
          
      - name: ğŸ“‚ Extract Native Libraries
        run: |
          mkdir -p src/main/resources/native
          tar -xzf native-libraries.tar.gz -C src/main/resources/native/
          
      - name: ğŸ·ï¸ Set Version
        id: version
        run: |
          if [ "${{ startsWith(github.ref, 'refs/tags/v') }}" = "true" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
            VERSION=${VERSION#v}  # ç§»é™¤vå‰ç¼€
          else
            VERSION="$(date +%Y%m%d)-$(echo $GITHUB_SHA | cut -c1-8)-SNAPSHOT"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # æ›´æ–°pom.xmlä¸­çš„ç‰ˆæœ¬å·
          mvn versions:set -DnewVersion=$VERSION -DgenerateBackupPoms=false
          
      - name: ğŸ“¦ Build and Deploy to GitHub Packages
        run: mvn clean deploy -DskipTests -q
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}


