name: ğŸš€ Build and Release Fast Image Java

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      rust_version:
        description: 'Rust release version to use (e.g., v0.2.1)'
        required: false
        default: 'latest'

env:
  JAVA_VERSION: '8'
  MAVEN_VERSION: '3.8.6'
  RUST_REPO: 'lihongjie0209/fast-image'

jobs:
  # ä¸‹è½½RuståŸç”Ÿåº“
  download-native-libs:
    name: ğŸ“¥ Download Native Libraries
    runs-on: ubuntu-latest
    timeout-minutes: 10  # è®¾ç½®10åˆ†é’Ÿè¶…æ—¶
    
    outputs:
      rust-version: ${{ steps.get-version.outputs.version }}
      
    steps:
      - name: ğŸ” Get Latest Rust Release
        id: get-version
        run: |
          if [ "${{ github.event.inputs.rust_version }}" = "latest" ] || [ -z "${{ github.event.inputs.rust_version }}" ]; then
            VERSION=$(curl -s https://api.github.com/repos/${{ env.RUST_REPO }}/releases/latest | jq -r .tag_name)
          else
            VERSION="${{ github.event.inputs.rust_version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using Rust version: $VERSION"
          
      - name: ğŸ“¦ Download Native Libraries
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          echo "Downloading native libraries from version: $VERSION"
          
          # åˆ›å»ºç›®å½•
          mkdir -p native-libs
          
          # ä¸‹è½½æ‰€æœ‰å¹³å°çš„åŸç”Ÿåº“
          PLATFORMS=(
            "fast_image-windows-x86_64.dll"
            "fast_image-windows-aarch64.dll"
            "libfast_image-linux-x86_64.so"
            "libfast_image-linux-aarch64.so"
            "libfast_image-macos-x86_64.dylib"
            "libfast_image-macos-aarch64.dylib"
          )
          
          for platform in "${PLATFORMS[@]}"; do
            echo "Downloading $platform..."
            curl -L -f \
              -H "Accept: application/octet-stream" \
              -o "native-libs/$platform" \
              "https://github.com/${{ env.RUST_REPO }}/releases/download/$VERSION/$platform" \
              || echo "Warning: Failed to download $platform (may not exist in this release)"
          done
          
          # æ£€æŸ¥ä¸‹è½½çš„æ–‡ä»¶
          echo "Downloaded files:"
          ls -la native-libs/
          
      - name: ğŸ—œï¸ Create Native Libraries Archive
        run: |
          cd native-libs
          tar -czf ../native-libraries.tar.gz *
          cd ..
          
      - name: ğŸ“¤ Upload Native Libraries
        uses: actions/upload-artifact@v4
        with:
          name: native-libraries
          path: native-libraries.tar.gz
          retention-days: 1

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    name: ğŸ”¨ Build and Test
    needs: download-native-libs
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15  # è®¾ç½®15åˆ†é’Ÿè¶…æ—¶
    
    strategy:
      fail-fast: false  # å…è®¸å…¶ä»–ä»»åŠ¡åœ¨ä¸€ä¸ªå¤±è´¥æ—¶ç»§ç»­
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [8, 11, 17, 21]
        exclude:
          # æ’é™¤ä¸€äº›ä¸å¿…è¦çš„ç»„åˆæ¥å‡å°‘jobæ•°é‡
          - os: windows-latest
            java: 11
          - os: macos-latest
            java: 11
          - os: ubuntu-latest
            java: 17
        
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          
      - name: ğŸ“¥ Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          name: native-libraries
          
      - name: ğŸ“‚ Extract Native Libraries
        shell: bash
        run: |
          # åˆ›å»ºèµ„æºç›®å½•
          mkdir -p src/main/resources/native
          
          # è§£å‹åŸç”Ÿåº“åˆ°æ­£ç¡®ä½ç½®
          tar -xzf native-libraries.tar.gz -C src/main/resources/native/
          
          # æ˜¾ç¤ºæ–‡ä»¶ç»“æ„
          echo "Native libraries structure:"
          find src/main/resources/native/ -type f -exec ls -la {} \;
          
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          
      - name: ğŸ”§ Compile Project
        run: mvn clean compile test-compile -q
        
      - name: ğŸ§ª Run Tests
        run: mvn test -q
        
      - name: ğŸ“Š Run Performance Benchmark
        if: matrix.java == 8 && matrix.os == 'ubuntu-latest'  # åªåœ¨ä¸€ä¸ªç¯å¢ƒè¿è¡Œbenchmark
        run: mvn exec:java@benchmark -q
        
      - name: ğŸ“¦ Package JAR
        run: mvn package -DskipTests -q
        
      - name: ğŸ“¤ Upload JAR Artifacts
        if: matrix.java == 8  # åªä¸Šä¼ Java 8çš„æ„å»ºç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: jar-${{ matrix.os }}
          path: target/*.jar
          retention-days: 30

  # å‘å¸ƒç‰ˆæœ¬
  create-release:
    name: ğŸ‰ Create Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [download-native-libs, build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 20  # è®¾ç½®20åˆ†é’Ÿè¶…æ—¶
    
    permissions:
      contents: write
      packages: write
      
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          
      - name: ğŸ“¥ Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          name: native-libraries
          
      - name: ğŸ“‚ Extract Native Libraries
        run: |
          mkdir -p src/main/resources/native
          tar -xzf native-libraries.tar.gz -C src/main/resources/native/
          
      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "rust_version=${{ needs.download-native-libs.outputs.rust-version }}" >> $GITHUB_OUTPUT
          
      - name: ğŸ“¦ Build Release JAR
        run: |
          mvn clean package -DskipTests
          
          # åˆ›å»ºå‘å¸ƒæ–‡ä»¶
          mkdir -p release-assets
          cp target/*.jar release-assets/
          
          # åˆ›å»ºæºç åŒ…
          git archive --format=zip --output=release-assets/fast-image-java-${{ steps.version.outputs.version }}-sources.zip HEAD
          
      - name: ğŸ“‹ Generate Release Notes
        id: release-notes
        run: |
          cat > release-notes.md << 'EOF'
          # Fast Image Java ${{ steps.version.outputs.version }}
          
          ## ğŸ“¦ Java Library for High-Performance Image Compression
          
          This release contains the Java JNI wrapper for the Fast Image compression library.
          
          ### ğŸš€ Features
          - High-performance JPEG compression using Rust backend
          - Cross-platform native library support (Windows/Linux/macOS)  
          - Comprehensive performance benchmarking suite
          - Easy-to-use API with quality control
          
          ### ğŸ“Š Performance Highlights
          - **Compression Ratio**: 10-16% better than JDK ImageIO
          - **Memory Efficiency**: 33% less memory usage
          - **Cross-Platform**: Consistent results across all platforms
          
          ### ğŸ”— Dependencies
          - **Native Libraries**: Built from [fast-image ${{ steps.version.outputs.rust-version }}](https://github.com/${{ env.RUST_REPO }}/releases/tag/${{ steps.version.outputs.rust-version }})
          - **Java Version**: Java 8+
          - **Platforms**: Windows (x64/ARM64), Linux (x64/ARM64), macOS (Intel/Apple Silicon)
          
          ### ğŸ“¥ Download
          - `fast-image-java-${{ steps.version.outputs.version }}.jar` - Complete library with native dependencies
          - `fast-image-java-${{ steps.version.outputs.version }}-sources.zip` - Source code
          
          ### ğŸš€ Quick Start
          ```java
          import cn.lihongjie.image.FastImageUtils;
          
          // Load and compress an image
          byte[] imageData = Files.readAllBytes(Paths.get("image.jpg"));
          byte[] compressed = FastImageUtils.compress(imageData, 70);
          
          // Save compressed result
          Files.write(Paths.get("compressed.jpg"), compressed);
          ```
          
          ### ğŸ§ª Performance Testing
          ```bash
          # Clone and test
          git clone https://github.com/your-username/fast-image-java.git
          cd fast-image-java
          mvn exec:java@benchmark
          ```
          
          ### ğŸ“š Documentation
          - [Performance Comparison Report](JPEG-COMPRESSION-COMPARISON.md)
          - [Quick Decision Guide](DECISION-GUIDE.md)
          - [Usage Guide](QUICK-GUIDE.md)
          
          Built with â¤ï¸ using Rust + JNI
          EOF
          
          # è®¾ç½®è¾“å‡º
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release-notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: "Fast Image Java ${{ steps.version.outputs.version }}"
          body: ${{ steps.release-notes.outputs.notes }}
          draft: false
          prerelease: false
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å‘å¸ƒåˆ°Maven Central (å¯é€‰)
  publish-maven:
    name: ğŸ“¦ Publish to Maven Central
    if: startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-RELEASE')
    needs: [download-native-libs, build-and-test]
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®30åˆ†é’Ÿè¶…æ—¶
    
    steps:
      - name: ğŸ›’ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: 8
          distribution: 'temurin'
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          
      - name: ğŸ“¥ Download Native Libraries
        uses: actions/download-artifact@v4
        with:
          name: native-libraries
          
      - name: ğŸ“‚ Extract Native Libraries
        run: |
          mkdir -p src/main/resources/native
          tar -xzf native-libraries.tar.gz -C src/main/resources/native/
          
      - name: ğŸ”‘ Import GPG Key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          
      - name: ğŸ“¦ Deploy to Maven Central
        run: mvn clean deploy -DskipTests
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
