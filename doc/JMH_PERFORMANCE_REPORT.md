# FastImage JMH 性能基准测试报告

*测试日期: 2025年8月19日*  
*测试环境: Windows x64, JMH 1.37*

## 测试概览

本报告基于 JMH (Java Microbenchmark Harness) 专业基准测试工具，对 FastImage 原生库与 Java 内置图像处理能力进行了全面的性能对比分析。

### 测试数据规模
- **小图像**: 256x256 像素
  - JPEG: 3,455 bytes
  - PNG: 6,149 bytes
- **中图像**: 512x512 像素  
  - JPEG: 9,437 bytes
  - PNG: 18,425 bytes
- **大图像**: 1024x1024 像素
  - JPEG: 20,496 bytes  
  - PNG: 34,937 bytes

### 测试配置
- **基准模式**: 平均时间 (AverageTime)
- **测试次数**: 3 次迭代
- **预热**: 2 次迭代
- **时间单位**: 毫秒 (ms/op)

## 详细性能分析

### 1. JPEG 压缩性能对比

| 图像大小 | Native (mozjpeg) | Java (ImageIO) | 性能提升 | 提升幅度 |
|----------|------------------|----------------|----------|----------|
| 小图像 (256x256) | 4.23 ms | 5.21 ms | **1.23x 更快** | 🟢 Native 优势 |
| 中图像 (512x512) | 13.01 ms | 8.03 ms | 0.62x 更慢 | 🔴 Java 优势 |
| 大图像 (1024x1024) | 40.41 ms | 20.66 ms | 0.51x 更慢 | 🔴 Java 优势 |

**关键发现**:
- ✅ **小图像**: Native 库在小图像上表现更好，快 23%
- ⚠️ **中大图像**: Java ImageIO 在处理较大图像时更快，快 38-49%
- 💡 **使用建议**: 小图像用 Native，大图像用 Java

### 2. PNG 压缩性能对比

| 图像大小 | Native (imagequant) | Java (ImageIO) | 性能提升 | 提升幅度 |
|----------|---------------------|----------------|----------|----------|
| 小图像 (256x256) | 3.27 ms | 4.88 ms | **1.49x 更快** | 🟢 Native 优势 |
| 中图像 (512x512) | 14.09 ms | 10.71 ms | 0.76x 更慢 | 🔴 Java 优势 |
| 大图像 (1024x1024) | 43.54 ms | 30.85 ms | 0.71x 更慢 | 🔴 Java 优势 |

**关键发现**:
- ✅ **小图像**: Native 库明显更快，快 49%
- ⚠️ **中大图像**: Java ImageIO 更快，快 24-29%
- 🎯 **质量优势**: Native 支持质量参数控制，Java 仅基础压缩

### 3. 图像旋转性能对比

#### PNG 旋转性能
| 图像大小 | Native (image crate) | Java (Graphics2D) | 性能提升 | 提升幅度 |
|----------|---------------------|-------------------|----------|----------|
| 小图像 (256x256) | 0.35 ms | 5.61 ms | **15.9x 更快** | 🚀 Native 巨大优势 |
| 中图像 (512x512) | 1.77 ms | 13.74 ms | **7.8x 更快** | 🚀 Native 巨大优势 |
| 大图像 (1024x1024) | 7.35 ms | 41.44 ms | **5.6x 更快** | 🚀 Native 巨大优势 |

#### JPEG 旋转性能  
| 图像大小 | Native (image crate) | Java (Graphics2D) | 性能提升 | 提升幅度 |
|----------|---------------------|-------------------|----------|----------|
| 小图像 (256x256) | 1.21 ms | 4.59 ms | **3.8x 更快** | 🚀 Native 巨大优势 |
| 中图像 (512x512) | 4.98 ms | 10.61 ms | **2.1x 更快** | 🟢 Native 优势 |
| 大图像 (1024x1024) | 19.00 ms | 30.60 ms | **1.6x 更快** | 🟢 Native 优势 |

**关键发现**:
- 🚀 **PNG 旋转**: Native 在所有尺寸上都有巨大优势 (5.6x - 15.9x)
- 🟢 **JPEG 旋转**: Native 始终更快 (1.6x - 3.8x)
- 📈 **规律**: 图像越小，Native 优势越明显

### 4. 组合操作性能对比 (旋转 + 压缩)

| 格式 | Native (Rust) | Java (ImageIO) | 性能提升 | 提升幅度 |
|------|---------------|----------------|----------|----------|
| JPEG (512x512) | 17.68 ms | 18.26 ms | **1.03x 更快** | 🟢 Native 略优 |
| PNG (512x512) | 15.98 ms | 25.86 ms | **1.62x 更快** | 🟢 Native 优势 |

**关键发现**:
- 🎯 **JPEG 组合**: 性能接近，Native 略优 3%
- 🟢 **PNG 组合**: Native 明显更快，快 62%
- 💡 **工作流优势**: Native 单次调用 vs Java 多步操作

## 综合性能排名

### 🥇 Native 库绝对优势场景
1. **图像旋转** - 所有格式和尺寸 (1.6x - 15.9x 更快)
2. **小图像压缩** - JPEG 和 PNG (1.23x - 1.49x 更快)
3. **PNG 组合操作** - 旋转+压缩 (1.62x 更快)

### 🥈 Java ImageIO 优势场景  
1. **大图像 JPEG 压缩** - 1024x1024 (1.96x 更快)
2. **中大图像 PNG 压缩** - 512x512, 1024x1024 (1.24x - 1.41x 更快)

### ⚖️ 性能接近场景
1. **JPEG 组合操作** - 性能差异小于 5%

## 推荐使用策略

### 🚀 强烈推荐使用 Native 库
- ✅ **所有图像旋转操作** - 性能提升显著
- ✅ **小图像处理** (< 512x512) - 速度和质量双优
- ✅ **PNG 复杂操作** - 组合操作效率高
- ✅ **质量要求高的场景** - Native 支持参数控制

### 🤔 考虑使用 Java ImageIO
- ⚠️ **大图像快速压缩** (> 1024x1024) - 仅速度优先场景
- ⚠️ **简单 PNG 压缩** - 无质量要求时
- ⚠️ **最小依赖需求** - 避免原生库依赖

### 🎯 混合策略
```java
// 推荐的智能选择策略
if (operation == ROTATION) {
    return useNativeLibrary(); // 始终使用 Native
} else if (format == JPEG && imageSize < 512*512) {
    return useNativeLibrary(); // 小 JPEG 用 Native
} else if (format == PNG && qualityRequired) {
    return useNativeLibrary(); // PNG 质量控制用 Native
} else {
    return useJavaImageIO(); // 其他场景用 Java
}
```

## 技术洞察

### Native 库优势原因
1. **SIMD 优化**: Rust image crate 使用 SIMD 指令加速
2. **内存效率**: 直接字节操作，无 JVM 内存管理开销
3. **算法优化**: mozjpeg 和 imagequant 专业图像算法
4. **缓存友好**: 更好的内存访问模式

### Java ImageIO 优势原因  
1. **JIT 优化**: 大图像处理时 JVM 优化生效
2. **并行处理**: 某些操作可能利用了多线程
3. **成熟实现**: 长期优化的 ImageIO 实现
4. **硬件加速**: 可能利用了硬件加速特性

## 结论

FastImage 原生库在**图像旋转**和**小图像处理**场景下表现卓越，特别是旋转操作提供了 **1.6x 到 15.9x** 的性能提升。虽然在大图像压缩上 Java ImageIO 更快，但 Native 库提供了更好的**压缩质量**和**参数控制能力**。

**总体建议**: 以 Native 库为主，Java ImageIO 为辅的混合策略，根据具体场景智能选择，可获得最佳的性能和质量平衡。

---

*基于 JMH 1.37 专业基准测试 | FastImage v1.0 | 测试环境: Windows x64*
